---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.14.1
  kernelspec:
    display_name: Python 3 (ipykernel)
    language: python
    name: python3
---

```{python}
from CitizenUAV.utils import gram_matrix
from CitizenUAV.losses import *
from CitizenUAV.data import InatDataModule
from CitizenUAV.models import InatClassifier
from torchvision.transforms import ToTensor
from torchvision.transforms.functional import to_pil_image
import numpy as np
import pandas as pd
from matplotlib import pyplot as plt
```

```{python}
data_dir = '/home/ndettmer/ssd_data/inat_subsets/case_study_1'
model_path = '/home/ndettmer/experiments/ma/classification/case_study_1/lightning_logs/version_11/checkpoints/epoch=49-step=43200.ckpt'
dm = InatDataModule(data_dir, batch_size=1, min_distance=5, species=['reynoutria japonica'])
dm.setup()
ds = dm.ds
model = InatClassifier.load_from_checkpoint(model_path)
_ = model.eval()
```

```{python}
def get_text_prediction(img):
    return ds.classes[model(img.unsqueeze(0)).detach().argmax().numpy()]
```

```{python}
sample_idx = np.random.choice(range(len(ds)))
img, t = ds[sample_idx]
```

```{python}
print(ds.classes[t])
plt.imshow(to_pil_image(img))
```

```{python}
get_text_prediction(img)
```

```{python}
from CitizenUAV.style_transfer import Normalization
norm_mean = torch.tensor([0.485, 0.456, 0.406])
norm_std = torch.tensor([0.229, 0.224, 0.225])
norm = Normalization(norm_mean, norm_std)
```

```{python}
norm(img).shape
```

```{python}
img.shape
```

```{python}
normalized = norm(img)
normalized = normalized.flatten(start_dim=1, end_dim=2)
for i in range(normalized.shape[0]):
    channel_values = pd.Series(normalized[i, :].numpy())
    print(channel_values.mean())
    print(channel_values.std())
    channel_values.plot.kde()
    plt.show()
```

```{python}
from CitizenUAV.utils import ds_mean_std
ds_mean_std(ds)
```

```{python}

```
