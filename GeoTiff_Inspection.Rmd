---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.14.1
  kernelspec:
    display_name: Python 3 (ipykernel)
    language: python
    name: python3
---

```{python}
import rasterio as rio
import rasterio.mask
import fiona
import pandas as pd
import numpy as np
import os
from tqdm import tqdm
from matplotlib import pyplot as plt
import seaborn as sns
```

## Maize 18.05.22

```{python}
data_dir = '/home/ndettmer/ssd_data/UOS_Data/'
filename = os.path.join(data_dir, '220518_maize_rgb.tif')
shapes_path = os.path.join(data_dir, '1805_maize')
maize_shapes_path = os.path.join(shapes_path, '1805_maize_maize.shp')
weeds_shapes_path = os.path.join(shapes_path, '1805_maize_weeds.shp')
names_df = pd.read_csv(os.path.join(data_dir, 'Pflanzennamen.csv'))
```

```{python}
maize_shapefile = fiona.open(maize_shapes_path)
weeds_shapefile = fiona.open(weeds_shapes_path)
ds = rasterio.open(filename)
```

```{python}
maize_shapefile[0]['properties'].keys()
```

```{python}
weeds_shapefile[0]['properties'].keys()
```

```{python}
shape = maize_shapefile[0]
```

```{python}
out_image, out_transform = rio.mask.mask(ds, [shape['geometry']], crop=True)
```

```{python}
(out_image > 0).sum()
```

```{python}
df = pd.DataFrame(columns=['note', 'species', 'shape_size'])

# fill with maize data
for shape in tqdm(maize_shapefile):
    if shape['geometry'] is None:
        continue
    shape_map, _ = rio.mask.mask(ds, [shape['geometry']], crop=True)
    props = shape['properties']
    row = pd.Series({'note': props['Vermerke'], 'species': 'ZEAMX', 'shape_size': (shape_map > 0).sum()})
    df.loc[len(df)] = row

# append weeds data
for shape in tqdm(weeds_shapefile):
    if shape['geometry'] is None:
        continue
    shape_map, _ = rio.mask.mask(ds, [shape['geometry']], crop=True)
    props = shape['properties']
    row = pd.Series({'note': props['Vermerk'], 'species': props['species'], 'shape_size': (shape_map > 0).sum()})
    df.loc[len(df)] = row

df.species.fillna('unknown', inplace=True)
df.species = df.species.astype('category')
df['label'] = df.species.cat.codes
df['botanical'] = df.apply(lambda row: names_df[names_df['Bayer-Code'] == row['species']]['Botanisch'].values[0] if row['species'] != 'unknown' else 'unknown', axis=1)
```

```{python}
size_dist = pd.DataFrame({'size_mean': df.groupby('species').shape_size.mean(), 'size_std': df.groupby('species').shape_size.std()})
size_dist
```

```{python}
sns.boxplot([df[df.species == spec].shape_size for spec in df.species.unique()])
```

```{python}
ds.close()
```

<!-- #region tags=[] -->
## Beets 16.05.22
<!-- #endregion -->

```{python}
filename = os.path.join(data_dir, '220516_beets_rgb.tif')
shapes_path = os.path.join(data_dir, '1605_beets')
beets_shapes_path = os.path.join(shapes_path, '1605_beets_beets.shp')
weeds_shapes_path = os.path.join(shapes_path, '1605_beets_weeds.shp')
```

```{python}
beets_shapefile = fiona.open(beets_shapes_path)
weeds_shapefile = fiona.open(weeds_shapes_path)
ds = rasterio.open(filename)
```

```{python}
beets_shapefile[0]['properties'].keys()
```

```{python}
weeds_shapefile[0]['properties'].keys()
```

```{python}
beets_shapefile[0]['properties'].keys()
```

```{python}
df = pd.DataFrame(columns=['species', 'shape_size'])

# fill with beets data
for shape in tqdm(beets_shapefile):
    if shape['geometry'] is None:
        continue
    shape_map, _ = rio.mask.mask(ds, [shape['geometry']], crop=True)
    row = pd.Series({'species': 'ZEAMX', 'shape_size': (shape_map > 0).sum()})
    df.loc[len(df)] = row

# append weeds data
for shape in tqdm(weeds_shapefile):
    if shape['geometry'] is None:
        continue
    shape_map, _ = rio.mask.mask(ds, [shape['geometry']], crop=True)
    row = pd.Series({'species': shape['properties']['species'], 'shape_size': (shape_map > 0).sum()})
    df.loc[len(df)] = row

df.species.fillna('unknown', inplace=True)
df.species = df.species.astype('category')
df['label'] = df.species.cat.codes
df['botanical'] = df.apply(lambda row: names_df[names_df['Bayer-Code'] == row['species']]['Botanisch'].values[0] if row['species'] != 'unknown' else 'unknown', axis=1)
```

```{python}
df.groupby('botanical').size().plot.bar()
```

```{python}
df[df.species != 'unknown'].groupby('botanical').size().plot.bar()
```

```{python}
size_dist = pd.DataFrame({'size_mean': df.groupby('species').shape_size.mean(), 'size_std': df.groupby('species').shape_size.std()})
size_dist
```

```{python}
sns.boxplot([df[df.species == spec].shape_size for spec in df.species.unique()])
```

```{python}
ds.close()
```
