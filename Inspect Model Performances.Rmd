---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.14.4
  kernelspec:
    display_name: Python 3 (ipykernel)
    language: python
    name: python3
---

```{python}
from CitizenUAV.models import InatClassifier
from CitizenUAV.processes import pixel_conf_mat, optimize_image_resnet
from CitizenUAV.data import GTiffDataset, InatDataModule
import numpy as np
import os
import random
from matplotlib import pyplot as plt
import seaborn as sns
import pandas as pd
import json
```

## Maize Ternary

```{python}
train_data_dir = '/home/ndettmer/ssd_data/inat_subsets/maize_ternary'
base_model_path = '/home/ndettmer/experiments/ma/classification/maize_ternary/lightning_logs/version_0/checkpoints/epoch=49-step=43200.ckpt'
test_data_dir = '/home/ndettmer/ssd_data/UOS_Data'
plot_dir = '/home/ndettmer/experiments/ma/classification/maize_ternary/plots'

resnet18_path = base_model_path.replace('version_0', 'version_3')
wide_resnet50_2_path = base_model_path.replace('version_0', 'version_2')
resnest50_path = base_model_path.replace('version_0', 'version_4')

train_classes = InatDataModule(train_data_dir).ds.classes
soil_label = train_classes.index('soil')

sample_size = 25
side_len = int(np.sqrt(sample_size))

class_map = json.dumps({
    'weeds': 'weed',
    'maize': 'zea mays',
    'soil': 'soil'
})
```

<!-- #region tags=[] -->
### 18.05.22
<!-- #endregion -->

```{python}
pred_dir = '/home/ndettmer/experiments/ma/classification/maize_ternary/predictions/220518_maize_rgb_test_area/'
target_dir = os.path.join(test_data_dir, '1805_maize')
ds_path = os.path.join(test_data_dir, '220518_maize_rgb_test.tif')
ds = GTiffDataset(ds_path, shape_dir=target_dir, stride=4, normalize=True)
```

<!-- #region tags=[] -->
#### ResNet50
<!-- #endregion -->

version_0

```{python}
predfile = os.path.join(pred_dir, 'version_0/23-02-17_10-57_probability_map.npy')
prob_mask = np.load(predfile)
prob_mask /= prob_mask.max()
```

```{python}
figure, axs = plt.subplots(1, 3, figsize=(15, 15))
for i in range(3):
    label = train_classes[i]
    #heat_map = sns.heatmap(pd.DataFrame(data=prob_mask[i]), annot=True, cmap='Spectral', fmt='g').get_figure()
    axs[i].imshow(prob_mask[i])
    axs[i].set_title(label)
plt.savefig(os.path.join(plot_dir, os.path.basename(predfile).replace('npy', 'png')))
```

Seems like the model mistakes these green markers for maize plants. 

```{python}
cm, df, f1 = pixel_conf_mat(ds_path, target_dir, train_data_dir, predfile, class_map, result_dir=plot_dir)
```

<!-- #region tags=[] -->
##### Pre-trained on ImageNet
<!-- #endregion -->

version_5

```{python}
predfile = os.path.join(pred_dir, 'version_5/23-02-17_11-49_probability_map.npy')
prob_mask = np.load(predfile)
prob_mask /= prob_mask.max()
```

```{python}
figure, axs = plt.subplots(1, 3, figsize=(15, 15))
for i in range(3):
    label = train_classes[i]
    #heat_map = sns.heatmap(pd.DataFrame(data=prob_mask[i]), annot=True, cmap='Spectral', fmt='g').get_figure()
    axs[i].imshow(prob_mask[i])
    axs[i].set_title(label)
plt.savefig(os.path.join(plot_dir, os.path.basename(predfile).replace('npy', 'png')))
```

Seems like the model mistakes these green markers for maize plants. 

```{python}
cm, df, f1 = pixel_conf_mat(ds_path, target_dir, train_data_dir, predfile, class_map, result_dir=plot_dir)
```

<!-- #region tags=[] -->
#### Wide Resnet50 2
<!-- #endregion -->

version_2

```{python}
predfile = os.path.join(pred_dir, 'version_2/23-02-17_11-15_probability_map.npy')
prob_mask = np.load(predfile)
prob_mask /= prob_mask.max()
```

```{python}
figure, axs = plt.subplots(1, 3, figsize=(15, 15))
for i in range(3):
    label = train_classes[i]
    #heat_map = sns.heatmap(pd.DataFrame(data=prob_mask[i]), annot=True, cmap='Spectral', fmt='g').get_figure()
    axs[i].imshow(prob_mask[i])
    axs[i].set_title(label)
plt.savefig(os.path.join(plot_dir, os.path.basename(predfile).replace('npy', 'png')))
```

Everything is weed!

```{python}
cm, df, f1 = pixel_conf_mat(ds_path, target_dir, train_data_dir, predfile, class_map, result_dir=plot_dir)
```

version_8

```{python}
predfile = os.path.join(pred_dir, 'version_8/23-02-17_12-38_probability_map.npy')
prob_mask = np.load(predfile)
prob_mask /= prob_mask.max()
```

```{python}
figure, axs = plt.subplots(1, 3, figsize=(15, 15))
for i in range(3):
    label = train_classes[i]
    #heat_map = sns.heatmap(pd.DataFrame(data=prob_mask[i]), annot=True, cmap='Spectral', fmt='g').get_figure()
    axs[i].imshow(prob_mask[i])
    axs[i].set_title(label)
plt.savefig(os.path.join(plot_dir, os.path.basename(predfile).replace('npy', 'png')))
```

WTF

```{python}
cm, df, f1 = pixel_conf_mat(ds_path, target_dir, train_data_dir, predfile, class_map, result_dir=plot_dir)
```

#### ResNet18


version_3

```{python}
#model = InatClassifier.load_from_checkpoint(resnet18_path)
#_ = model.eval()
```

```{python}
predfile = os.path.join(pred_dir, 'version_3/23-02-17_11-37_probability_map.npy')
prob_mask = np.load(predfile)
prob_mask /= prob_mask.max()
```

```{python}
figure, axs = plt.subplots(1, 3, figsize=(15, 15))
for i in range(3):
    label = train_classes[i]
    #heat_map = sns.heatmap(pd.DataFrame(data=prob_mask[i]), annot=True, cmap='Spectral', fmt='g').get_figure()
    axs[i].imshow(prob_mask[i])
    axs[i].set_title(label)
plt.savefig(os.path.join(plot_dir, os.path.basename(predfile).replace('npy', 'png')))
```

Seems like the model mistakes these green markers for maize plants. 

```{python}
cm, df, f1 = pixel_conf_mat(ds_path, target_dir, train_data_dir, predfile, class_map, result_dir=plot_dir)
```

<!-- #region jp-MarkdownHeadingCollapsed=true tags=[] -->
##### Pre-trained
<!-- #endregion -->

version_6

```{python}
predfile = os.path.join(pred_dir, 'version_6/23-02-17_12-05_probability_map.npy')
prob_mask = np.load(predfile)
prob_mask /= prob_mask.max()
```

```{python}
figure, axs = plt.subplots(1, 3, figsize=(15, 15))
for i in range(3):
    label = train_classes[i]
    #heat_map = sns.heatmap(pd.DataFrame(data=prob_mask[i]), annot=True, cmap='Spectral', fmt='g').get_figure()
    axs[i].imshow(prob_mask[i])
    axs[i].set_title(label)
plt.savefig(os.path.join(plot_dir, os.path.basename(predfile).replace('npy', 'png')))
```

Seems like the model mistakes these green markers for maize plants. 

```{python}
cm, df, f1 = pixel_conf_mat(ds_path, target_dir, train_data_dir, predfile, class_map, result_dir=plot_dir)
```

Slight improvement with ImageNet weights

<!-- #region tags=[] -->
#### ResNest50
<!-- #endregion -->

version_4

```{python}
predfile = os.path.join(pred_dir, 'version_4/23-02-17_16-55_probability_map.npy')
prob_mask = np.load(predfile)
prob_mask /= prob_mask.max()
```

```{python}
figure, axs = plt.subplots(1, 3, figsize=(15, 15))
for i in range(3):
    label = train_classes[i]
    #heat_map = sns.heatmap(pd.DataFrame(data=prob_mask[i]), annot=True, cmap='Spectral', fmt='g').get_figure()
    axs[i].imshow(prob_mask[i])
    axs[i].set_title(label)
plt.savefig(os.path.join(plot_dir, os.path.basename(predfile).replace('npy', 'png')))
```

Predictions are more clustered per class, but the confusion with weed is worse.

```{python}
cm, df, f1 = pixel_conf_mat(ds_path, target_dir, train_data_dir, predfile, class_map, result_dir=plot_dir)
```

<!-- #region jp-MarkdownHeadingCollapsed=true tags=[] -->
##### Pre-trained on ImageNet
<!-- #endregion -->

version_7

```{python}
predfile = os.path.join(pred_dir, 'version_7/23-02-17_12-17_probability_map.npy')
prob_mask = np.load(predfile)
prob_mask /= prob_mask.max()
```

```{python}
figure, axs = plt.subplots(1, 3, figsize=(15, 15))
for i in range(3):
    label = train_classes[i]
    #heat_map = sns.heatmap(pd.DataFrame(data=prob_mask[i]), annot=True, cmap='Spectral', fmt='g').get_figure()
    axs[i].imshow(prob_mask[i])
    axs[i].set_title(label)
plt.savefig(os.path.join(plot_dir, os.path.basename(predfile).replace('npy', 'png')))
```

Predictions are more clustered per class, but the confusion with weed is worse.

```{python}
cm, df, f1 = pixel_conf_mat(ds_path, target_dir, train_data_dir, predfile, class_map, result_dir=plot_dir)
```

Plot looks good, but the confusion matrix is total chaos. Apparently even soil can't be detected properly anymore. 

<!-- #region jp-MarkdownHeadingCollapsed=true tags=[] -->
### 13.06.22
<!-- #endregion -->

```{python}
pred_dir = '/home/ndettmer/experiments/ma/classification/maize_ternary/predictions/220613_maize_rgb_test_area/'
ds_path = os.path.join(test_data_dir, '220613_maize_rgb_test_area.tif')
ds = GTiffDataset(ds_path, stride=4, normalize=True)
```

#### ResNet50


version_0

```{python}
predfile = os.path.join(pred_dir, 'version_0/23-02-17_12-59_probability_map.npy')
prob_mask = np.load(predfile)
prob_mask /= prob_mask.max()
```

```{python}
figure, axs = plt.subplots(1, 3, figsize=(15, 15))
for i in range(3):
    label = train_classes[i]
    #heat_map = sns.heatmap(pd.DataFrame(data=prob_mask[i]), annot=True, cmap='Spectral', fmt='g').get_figure()
    axs[i].imshow(prob_mask[i])
    axs[i].set_title(label)
plt.savefig(os.path.join(plot_dir, os.path.basename(predfile).replace('npy', 'png')))
```

##### Pre-trained on ImageNet


version_5

```{python}
predfile = os.path.join(pred_dir, 'version_5/23-02-17_13-53_probability_map.npy')
prob_mask = np.load(predfile)
prob_mask /= prob_mask.max()
```

```{python}
figure, axs = plt.subplots(1, 3, figsize=(15, 15))
for i in range(3):
    label = train_classes[i]
    #heat_map = sns.heatmap(pd.DataFrame(data=prob_mask[i]), annot=True, cmap='Spectral', fmt='g').get_figure()
    axs[i].imshow(prob_mask[i])
    axs[i].set_title(label)
plt.savefig(os.path.join(plot_dir, os.path.basename(predfile).replace('npy', 'png')))
```

<!-- #region tags=[] -->
#### Wide Resnet50 2
<!-- #endregion -->

version_2

```{python}
predfile = os.path.join(pred_dir, 'version_2/23-02-17_13-17_probability_map.npy')
prob_mask = np.load(predfile)
prob_mask /= prob_mask.max()
```

```{python}
figure, axs = plt.subplots(1, 3, figsize=(15, 15))
for i in range(3):
    label = train_classes[i]
    #heat_map = sns.heatmap(pd.DataFrame(data=prob_mask[i]), annot=True, cmap='Spectral', fmt='g').get_figure()
    axs[i].imshow(prob_mask[i])
    axs[i].set_title(label)
plt.savefig(os.path.join(plot_dir, os.path.basename(predfile).replace('npy', 'png')))
```

That's not too bad! Destinction between plant and soil seems to wokr quite well. Maize and weed on the other hand can hardly be distinguished. 


#### ResNet18


version_3

```{python}
predfile = os.path.join(pred_dir, 'version_3/23-02-17_13-40_probability_map.npy')
prob_mask = np.load(predfile)
prob_mask /= prob_mask.max()
```

```{python}
figure, axs = plt.subplots(1, 3, figsize=(15, 15))
for i in range(3):
    label = train_classes[i]
    #heat_map = sns.heatmap(pd.DataFrame(data=prob_mask[i]), annot=True, cmap='Spectral', fmt='g').get_figure()
    axs[i].imshow(prob_mask[i])
    axs[i].set_title(label)
plt.savefig(os.path.join(plot_dir, os.path.basename(predfile).replace('npy', 'png')))
```
##### Pre-trained on ImageNet


version_6

```{python}
predfile = os.path.join(pred_dir, 'version_6/23-02-17_14-12_probability_map.npy')
prob_mask = np.load(predfile)
prob_mask /= prob_mask.max()
```

```{python}
figure, axs = plt.subplots(1, 3, figsize=(15, 15))
for i in range(3):
    label = train_classes[i]
    #heat_map = sns.heatmap(pd.DataFrame(data=prob_mask[i]), annot=True, cmap='Spectral', fmt='g').get_figure()
    axs[i].imshow(prob_mask[i])
    axs[i].set_title(label)
plt.savefig(os.path.join(plot_dir, os.path.basename(predfile).replace('npy', 'png')))
```

Respectively that looks great! A lot of maize predicitons between all the weed predicitons. Most we had so far!


#### ResNest50


version_4

```{python}
predfile = os.path.join(pred_dir, 'version_4/_probability_map.npy')
prob_mask = np.load(predfile)
prob_mask /= prob_mask.max()
```

```{python}
figure, axs = plt.subplots(1, 3, figsize=(15, 15))
for i in range(3):
    label = train_classes[i]
    #heat_map = sns.heatmap(pd.DataFrame(data=prob_mask[i]), annot=True, cmap='Spectral', fmt='g').get_figure()
    axs[i].imshow(prob_mask[i])
    axs[i].set_title(label)
plt.savefig(os.path.join(plot_dir, os.path.basename(predfile).replace('npy', 'png')))
```
##### Pre-trained on ImageNet


version_7

```{python}
predfile = os.path.join(pred_dir, 'version_7/23-02-17_14-25_probability_map.npy')
prob_mask = np.load(predfile)
prob_mask /= prob_mask.max()
```

```{python}
figure, axs = plt.subplots(1, 3, figsize=(15, 15))
for i in range(3):
    label = train_classes[i]
    #heat_map = sns.heatmap(pd.DataFrame(data=prob_mask[i]), annot=True, cmap='Spectral', fmt='g').get_figure()
    axs[i].imshow(prob_mask[i])
    axs[i].set_title(label)
plt.savefig(os.path.join(plot_dir, os.path.basename(predfile).replace('npy', 'png')))
```
The tracks of the tractor are very well visible. Soil detection works great! Maize detection still okay-ish...

```{python}

```
