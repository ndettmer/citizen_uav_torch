---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.14.4
  kernelspec:
    display_name: Python 3 (ipykernel)
    language: python
    name: python3
---

```{python}
from CitizenUAV.data import GTiffDataset
import os
from tqdm import tqdm
import fiona
import numpy as np
from matplotlib import pyplot as plt
from matplotlib import patches
import rasterio as rio
from torchvision.transforms.functional import to_pil_image
```

```{python}
data_dir = '/home/ndettmer/ssd_data/UOS_Data'
may_datapath = os.path.join(data_dir, '220518_maize_rgb_test_area.tif')
may_shape_dir = os.path.join(data_dir, '1805_maize')
may_maize_shape_path = os.path.join(may_shape_dir, '1805_maize_maize.shp')
may_weeds_shape_path = os.path.join(may_shape_dir, '1805_maize_weeds.shp')
may_out_dir = os.path.join(data_dir, 'maize_ternary_valds_may')
may_maize_out_dir = os.path.join(may_out_dir, 'maize')
may_weeds_out_dir = os.path.join(may_out_dir, 'weeds')
june_datapath = os.path.join(data_dir, '220613_maize_rgb_test_area.tif')
june_shape_dir = os.path.join(data_dir, '1306_maize')
june_maize_shape_path = os.path.join(june_shape_dir, '1306_maize_maize.shp')
june_weeds_shape_path = os.path.join(june_shape_dir, '1306_maize_weeds.shp')
june_out_dir = os.path.join(data_dir, 'maize_ternary_valds_june')
june_maize_out_dir = os.path.join(june_out_dir, 'maize')
june_weeds_out_dir = os.path.join(june_out_dir, 'weeds')
box_size = 128
box_half = box_size // 2
val_size = 400
```

```{python}
mayds = GTiffDataset(may_datapath, may_shape_dir, 128, 32)
juneds = GTiffDataset(june_datapath, may_shape_dir, 128, 32)
```

## May


### Maize

```{python}
with rio.open(may_datapath) as rds:
    gt_transform = rds.transform
    len_filename_coord = len(str(max(rds.width, rds.height)))
rev_gt_transform = ~gt_transform
```

```{python}
with fiona.open(may_maize_shape_path) as maize_shapefile:
    may_maize_shapes = [feature["geometry"] for feature in maize_shapefile]
```

```{python}
may_maize_val_idx = np.random.choice(list(range(len(may_maize_shapes))), size=val_size)
not_may_maize_val_idx = list(set(list(range(len(may_maize_shapes)))) ^ set(may_maize_val_idx))
```

```{python}
for i in tqdm(may_maize_val_idx):
    shape = may_maize_shapes[i]
    polys = shape['coordinates']
    coordinates = []
    for poly in polys:
        coordinates += poly
    local_coordinates = np.array([(rev_gt_transform * coord) for coord in coordinates])
    centroid = np.around(np.mean(local_coordinates, axis=0)).astype(int)
    bb = [centroid[1] - box_half, centroid[1] + box_half, centroid[0] - box_half, centroid[0] + box_half]
    img = to_pil_image(mayds.get_bb_data(bb))
    filename = "_".join([str(c).zfill(len_filename_coord) for c in bb]) + ".png"
    img.save(os.path.join(may_out_dir, 'maize', filename), "png")
```

### Weeds

```{python}
with fiona.open(may_weeds_shape_path) as weeds_shapefile:
    may_weeds_shapes = [feature["geometry"] for feature in weeds_shapefile]
```

```{python}
may_weeds_val_idx = np.random.choice(list(range(len(may_weeds_shapes))), size=val_size)
not_may_weeds_val_idx = list(set(list(range(len(may_weeds_shapes)))) ^ set(may_weeds_val_idx))
```

```{python}
for i in tqdm(may_weeds_val_idx):
    if may_weeds_shapes[i] is None:
        continue
    shape = may_weeds_shapes[i]
    polys = shape['coordinates']
    coordinates = []
    for poly in polys:
        coordinates += poly
    local_coordinates = np.array([(rev_gt_transform * coord) for coord in coordinates])
    centroid = np.around(np.mean(local_coordinates, axis=0)).astype(int)
    bb = [centroid[1] - box_half, centroid[1] + box_half, centroid[0] - box_half, centroid[0] + box_half]
    img = to_pil_image(mayds.get_bb_data(bb))
    filename = "_".join([str(c).zfill(len_filename_coord) for c in bb]) + ".png"
    img.save(os.path.join(may_out_dir, 'weeds', filename), "png")
```

## June


### Maize

```{python}
with fiona.open(june_maize_shape_path) as maize_shapefile:
    june_maize_shapes = [feature["geometry"] for feature in maize_shapefile]
```

```{python}
june_maize_val_idx = np.random.choice(list(range(len(june_maize_shapes))), size=val_size)
not_june_maize_val_idx = list(set(list(range(len(june_maize_shapes)))) ^ set(june_maize_val_idx))
```

```{python}
for i in tqdm(june_maize_val_idx):
    if june_maize_shapes[i] is None:
        continue
    shape = june_maize_shapes[i]
    polys = shape['coordinates']
    coordinates = []
    for poly in polys:
        coordinates += poly
    local_coordinates = np.array([(rev_gt_transform * coord) for coord in coordinates])
    centroid = np.around(np.mean(local_coordinates, axis=0)).astype(int)
    bb = [centroid[1] - box_half, centroid[1] + box_half, centroid[0] - box_half, centroid[0] + box_half]
    img = to_pil_image(juneds.get_bb_data(bb))
    filename = "_".join([str(c).zfill(len_filename_coord) for c in bb]) + ".png"
    img.save(os.path.join(june_out_dir, 'maize', filename), "png")
```

### Weeds

```{python}
with fiona.open(june_weeds_shape_path) as weeds_shapefile:
    june_weeds_shapes = [feature["geometry"] for feature in weeds_shapefile]
```

```{python}
june_weeds_val_idx = np.random.choice(list(range(len(june_weeds_shapes))), size=val_size)
not_june_weeds_val_idx = list(set(list(range(len(june_weeds_shapes)))) ^ set(june_weeds_val_idx))
```

```{python}
for i in tqdm(june_weeds_val_idx):
    if june_weeds_shapes[i] is None:
        continue
    shape = june_weeds_shapes[i]
    polys = shape['coordinates']
    coordinates = []
    for poly in polys:
        coordinates += poly
    try:
        local_coordinates = np.array([(rev_gt_transform * coord) for coord in coordinates])
    except TypeError:
        polys = coordinates
        coordinates = []
        for poly in polys:
            coordinates += poly
        local_coordinates = np.array([(rev_gt_transform * coord) for coord in coordinates])
    centroid = np.around(np.mean(local_coordinates, axis=0)).astype(int)
    bb = [centroid[1] - box_half, centroid[1] + box_half, centroid[0] - box_half, centroid[0] + box_half]
    img = to_pil_image(juneds.get_bb_data(bb))
    filename = "_".join([str(c).zfill(len_filename_coord) for c in bb]) + ".png"
    img.save(os.path.join(june_out_dir, 'weeds', filename), "png")
```

```{python}
fig, ax = plt.subplots()
ax.scatter(local_coordinates[:, 0], local_coordinates[:, 1], marker='o')
ax.scatter([centroid[0]], [centroid[1]], marker='x')
box = patches.Rectangle((bb[2], bb[0]), 128, 128, linewidth=1, edgecolor='r', facecolor='none')
ax.add_patch(box)
plt.show()
```

```{python}

```
