---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.14.1
  kernelspec:
    display_name: Python 3 (ipykernel)
    language: python
    name: python3
---

```{python}
from CitizenUAV.models import InatRegressor
from CitizenUAV.data import InatDistDataModule
import torch
import pandas as pd
from torch.nn import functional as F
import os
from tqdm import tqdm
import numpy as np
```

```{python}
data_dir = '***'
model_path = '***/epoch=15-step=3248.ckpt'
seed = 42
torch.manual_seed(seed)
dm = InatDistDataModule(data_dir, img_size=256)
ds = dm.ds

model = InatRegressor.load_from_checkpoint(model_path)
model.eval()
```

```{python}
df = pd.DataFrame(columns=['filename', 'target', 'prediction', 'mse', 'target_raw', 'prediction_raw', 'diff_raw'])
for i in tqdm(range(len(ds))):
    x, y = ds[i]
    x = x.unsqueeze(0)
    y = torch.Tensor([y]).unsqueeze(0)

    y_hat = model(x)

    path, _ = ds.samples[i]
    filename = os.path.basename(path)
    mse = F.mse_loss(y_hat, y)
    
    y_hat = y_hat.detach().numpy()[0, 0]
    mse = mse.detach().numpy()
    
    y_raw = y * (ds.max_dist - ds.min_dist) + ds.min_dist
    y_hat_raw = y_hat * (ds.max_dist - ds.min_dist) + ds.min_dist
    diff_raw = np.abs(y_hat - y)
    
    y_raw = y_raw.numpy()[0, 0]
    diff_raw = diff_raw.numpy()[0, 0]
    
    row = [filename, y.numpy()[0, 0], y_hat, mse, y_raw, y_hat_raw, diff_raw]
    df.loc[i] = row
```

```{python}
df['correct_border'] = (df.target_raw >= 5) & (df.prediction_raw >= 5) ^ (df.target_raw < 5) & (df.prediction_raw < 5)
```

```{python}
len(df[~df.correct_border]) / len(df)
```

```{python}
df.to_csv('***/distance_regression/22-10-17_eval.csv')
```

```{python}
df.mse = df.mse.astype(float)
```

```{python}
df.mse.plot.kde()
```

```{python}
worst_samples = df.nlargest(9, columns=['mse'])
```

```{python}
from PIL import Image
from matplotlib import pyplot as plt

plt.figure(figsize=(20,20))
for i, (idx, row)  in enumerate(worst_samples.iterrows()):
    plt.subplot(3, 3, i+1)
    img = Image.open(os.path.join(data_dir, row.filename))
    plt.imshow(img)
plt.show()
```

```{python}
worst_samples
```

```{python}
ds.min_dist
```

```{python}
ds.max_dist
```

```{python}
for idx, row in tqdm(df.sample(frac=.2).iterrows()):
    fig = plt.figure(figsize=(20, 20))
    plt.title(f"target={int(row.target_raw)}; prediction={int(row.prediction_raw)}; {'correct' if row.correct_border else 'not correct'}")
    img = Image.open(os.path.join(data_dir, row.filename))
    plt.imshow(img)
    plt.savefig(f'***/distance_regression/eval_img/{idx}.png')
    plt.close()
```

```{python}

```
